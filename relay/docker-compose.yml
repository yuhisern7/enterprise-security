version: '3.8'

services:
  relay-server:
    build:
      context: ..
      dockerfile: relay/Dockerfile
    container_name: security-relay-server
    restart: unless-stopped
    network_mode: host
    volumes:
      # Mount ai_training_materials (825 MB training data)
      - ./ai_training_materials:/app/relay/ai_training_materials
      # Mount crypto_keys (HMAC shared secrets)
      - ./crypto_keys:/app/relay/crypto_keys
      # Mount AI folder for crypto_security access
      - ../AI:/app/AI
    env_file:
      - .env
    environment:
      # Override specific settings if needed
      - RELAY_HOST=${RELAY_HOST:-0.0.0.0}
      - RELAY_PORT=${RELAY_PORT:-60001}
      - API_PORT=${API_PORT:-60002}
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.connect(('localhost', 60001)); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
