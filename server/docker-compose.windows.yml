services:
  enterprise-security:
    build:
      context: ..
      dockerfile: server/Dockerfile
    image: battle-hardened-ai
    container_name: battle-hardened-ai
    restart: unless-stopped  # Auto-restart on crash (unless manually stopped)
    # Windows uses bridge mode (host mode doesn't work on Windows)
    # This limits network scanning to Docker network only
    privileged: true
    
    # Port mapping for Windows bridge mode
    ports:
      - "60000:60000"  # Dashboard
      - "60001:60001"  # P2P/Relay
    
    # Resource limits - prevent memory exhaustion attacks
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    
    # Volumes - persist data between restarts
    volumes:
      - ./json:/app/json                      # Threat logs (persistent)
      - ../AI:/app/AI                          # ML models + code (persistent - survives rebuilds!)
      # REMOVED: ExploitDB volume (Premium mode downloads models from relay, not ExploitDB)
      # Free mode users: Uncomment below to mount local ExploitDB
      # - ../AI/exploitdb:/app/AI/exploitdb:ro  # Optional: Free mode only
    
    # Environment variables (load from .env file in server directory)
    env_file:
      - .env
    environment:
      - FLASK_ENV=${FLASK_ENV:-production}
      - TZ=${TZ:-Asia/Kuala_Lumpur}
      - VIRUSTOTAL_API_KEY=${VIRUSTOTAL_API_KEY}
      - ABUSEIPDB_API_KEY=${ABUSEIPDB_API_KEY:-}
      - AI_LEARNING_ENABLED=${AI_LEARNING_ENABLED:-true}
      - DASHBOARD_PORT=${DASHBOARD_PORT:-60000}
      - P2P_PORT=${P2P_PORT:-60001}
      - SIGNATURE_MODE=${SIGNATURE_MODE:-auto}  # auto, master, or client
      - KERNEL_TELEMETRY_ENABLED=${KERNEL_TELEMETRY_ENABLED:-false}  # MODULE A: eBPF (disabled on Windows)
      - KERNEL_TELEMETRY_INTERFACE=${KERNEL_TELEMETRY_INTERFACE:-Ethernet}
      - RELAY_ENABLED=${RELAY_ENABLED:-false}  # Enable remote training (set to true + configure URLs)
      - RELAY_URL=${RELAY_URL:-}  # WebSocket relay (wss://your-vps-ip:60001) - see RELAY_SETUP.md
      - RELAY_API_URL=${RELAY_API_URL:-}  # Model download API (https://your-vps-ip:60002) - see RELAY_SETUP.md
      - RELAY_CRYPTO_ENABLED=${RELAY_CRYPTO_ENABLED:-true}
      - CUSTOMER_ID=${CUSTOMER_ID:-}  # Unique customer identifier
      - PEER_NAME=${PEER_NAME:-windows-node}  # Customer location/name
    
    # Health check (uses HTTPS dashboard port, self-signed cert)
    healthcheck:
      test: ["CMD", "curl", "-kf", "https://localhost:${DASHBOARD_PORT:-60000}/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# Optional: persistent data volumes (uncomment if you want Docker-managed volumes)
# volumes:
#   security_data:
#     driver: local
