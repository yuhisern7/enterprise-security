services:
  enterprise-security:
    build:
      context: ..
      dockerfile: server/Dockerfile
    image: battle-hardened-ai
    container_name: battle-hardened-ai
    network_mode: host   # Required for eBPF/XDP to see real traffic
    pid: host            # Required for syscall â†” process correlation
    
    # DEFENSE-GRADE: eBPF/XDP capabilities (observer-only mode)
    # This enables kernel-level telemetry (MODULE A)
    # SAFE: Observer-only, no packet modification
    cap_add:
      - SYS_ADMIN        # Required on some kernels for eBPF
      - BPF              # Load eBPF programs
      - PERFMON          # Read kernel events
      - NET_ADMIN        # Attach to network hooks
      - NET_RAW          # Raw socket access (scapy fallback)
    
    security_opt:
      - apparmor=unconfined   # Allow BPF syscalls
      - seccomp=unconfined    # BPF syscalls otherwise blocked
    
    # Note: NOT using --privileged (too broad, unnecessary)
    # This is observer-only - no packet modification or drops
    
    # Volumes - persist data between restarts
    volumes:
      - ./json:/app/json                      # Threat logs (persistent)
      - ../AI:/app/AI                          # ML models + code (persistent - survives rebuilds!)
      # REMOVED: ExploitDB volume (Premium mode downloads models from relay, not ExploitDB)
      # Free mode users: Uncomment below to mount local ExploitDB
      # - ../AI/exploitdb:/app/AI/exploitdb:ro  # Optional: Free mode only
    
    # Environment variables (load from .env file in server directory)
    env_file:
      - .env
    environment:
      - FLASK_ENV=${FLASK_ENV:-production}
      - TZ=${TZ:-Asia/Kuala_Lumpur}
      - VIRUSTOTAL_API_KEY=${VIRUSTOTAL_API_KEY}
      - ABUSEIPDB_API_KEY=${ABUSEIPDB_API_KEY:-}
      - AI_LEARNING_ENABLED=${AI_LEARNING_ENABLED:-true}
      - DASHBOARD_PORT=${DASHBOARD_PORT:-60000}
      - P2P_PORT=${P2P_PORT:-60001}
      - SIGNATURE_MODE=${SIGNATURE_MODE:-auto}  # auto, master, or client
      - KERNEL_TELEMETRY_ENABLED=${KERNEL_TELEMETRY_ENABLED:-true}  # MODULE A: eBPF
      - KERNEL_TELEMETRY_INTERFACE=${KERNEL_TELEMETRY_INTERFACE:-eth0}
      - RELAY_ENABLED=${RELAY_ENABLED:-false}
      - RELAY_URL=${RELAY_URL:-}
      - RELAY_CRYPTO_ENABLED=${RELAY_CRYPTO_ENABLED:-true}
      - PEER_NAME=${PEER_NAME:-linux-node}
      - CUSTOMER_ID=${CUSTOMER_ID:-}
    
    # Health check (uses HTTPS dashboard port, self-signed cert)
    healthcheck:
      test: ["CMD", "curl", "-kf", "https://localhost:${DASHBOARD_PORT:-60000}/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# Optional: persistent data volumes (uncomment if you want Docker-managed volumes)
# volumes:
#   security_data:
#     driver: local
